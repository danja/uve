<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UVE - Universal Virtual Environment</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    
    #container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f0f0f0;
    }
    
    #info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 300px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 5px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    #class-info {
      margin-top: 10px;
      padding: 10px;
      background: #e9e9e9;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .title {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .toolbar {
      position: absolute;
      bottom: 10px;
      left: 10px;
      display: flex;
      gap: 10px;
    }
    
    .toolbar button {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    .toolbar button:hover {
      background: #2980b9;
    }
    
    .loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  
  <div id="info-panel">
    <div class="title">UVE - Universal Virtual Environment</div>
    <div id="status">Initializing...</div>
    <div id="class-info">
      <p>No class selected</p>
    </div>
  </div>
  
  <div class="toolbar">
    <button id="load-foaf">Load FOAF Example</button>
    <button id="reset-camera">Reset Camera</button>
  </div>
  
  <div id="loading" class="loading" style="display: none;">
    Loading data...
  </div>
  
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
        "rdf-ext": "https://cdn.jsdelivr.net/npm/rdf-ext@2.5.1/bundles/rdf-ext.min.js",
        "loglevel": "https://cdn.jsdelivr.net/npm/loglevel@1.8.1/+esm"
      }
    }
  </script>
  
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import log from 'loglevel';
    
    // Set up logging
    log.setLevel(log.levels.INFO);
    log.info('UVE initializing...');
    
    // Import UVE modules when they're ready
    import { UVEApp, EventBus, UVEEvent } from './uve-core.js';
    import { loadFOAFExample } from './foaf-example.js';
    
    // Create RDF-Ext proxy until the actual library is available
    const rdf = {
      namespace: function(ns) {
        return function(local) {
          return { value: ns + local, toString: () => ns + local };
        };
      },
      namedNode: function(uri) {
        return { value: uri, toString: () => uri };
      },
      literal: function(value) {
        return { value: value, toString: () => `"${value}"` };
      },
      dataset: function() {
        return {
          size: 0,
          toString: () => 'Empty dataset',
          toStream: () => {},
          add: function() { return this; }
        };
      },
      grapoi: function() {
        return {
          addOut: function() { return this; },
          node: function() { return this; },
          out: function() { return this; }
        };
      }
    };
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
      // DOM elements
      const container = document.getElementById('container');
      const statusEl = document.getElementById('status');
      const classInfoEl = document.getElementById('class-info');
      const loadFoafBtn = document.getElementById('load-foaf');
      const resetCameraBtn = document.getElementById('reset-camera');
      const loadingEl = document.getElementById('loading');
      
      // Set up Three.js
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf0f0f0);
      
      const camera = new THREE.PerspectiveCamera(
        75, 
        window.innerWidth / window.innerHeight, 
        0.1, 
        1000
      );
      camera.position.z = 15;
      
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      container.appendChild(renderer.domElement);
      
      // Add orbit controls
      THREE.OrbitControls = OrbitControls;
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      
      // Add lights
      const ambientLight = new THREE.AmbientLight(0x404040);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);
      
      // Create event bus
      const eventBus = new EventBus();
      
      // Subscribe to events for updating UI
      eventBus.subscribe('rdf:loaded', (event) => {
        statusEl.textContent = `Loaded ${event.data.size} triples from ${event.data.source}`;
        loadingEl.style.display = 'none';
      });
      
      eventBus.subscribe('rdf:error', (event) => {
        statusEl.textContent = `Error: ${event.data.error}`;
        loadingEl.style.display = 'none';
      });
      
      eventBus.subscribe('class:select', (event) => {
        const classId = event.data.classId;
        const classObj = app.modelManager.classMap.get(classId);
        
        if (classObj) {
          classInfoEl.innerHTML = `
            <h3>${classObj.get('label') || classId}</h3>
            <p><strong>URI:</strong> ${classObj.get('uri') || classId}</p>
            <p><strong>Parents:</strong> ${(classObj.get('parents') || []).join(', ') || 'None'}</p>
          `;
        }
      });
      
      // Create UVE App
      const app = new UVEApp({
        rdf,
        three: THREE
      });
      
      // Initialize app with container
      app.initialize(container);
      
      // Add model manager to the scene
      app.modelManager.scene = scene;
      
      // Load FOAF example button
      loadFoafBtn.addEventListener('click', () => {
        loadingEl.style.display = 'flex';
        loadFOAFExample(app, rdf);
      });
      
      // Reset camera button
      resetCameraBtn.addEventListener('click', () => {
        camera.position.set(0, 0, 15);
        camera.lookAt(0, 0, 0);
        controls.update();
      });
      
      // Handle window resize
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
      
      // Animation loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      
      animate();
      
      statusEl.textContent = 'Ready. Click "Load FOAF Example" to begin.';
    });
  </script>
</body>
</html>
